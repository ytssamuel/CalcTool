<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é€€ä¼‘ç”Ÿæ´»è²»è¨ˆç®—å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="common-styles.css">
  <style>
    /* é é¢ç‰¹å®šæ¨£å¼ */
    body {
      background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 50%, #2BFF88 100%);
    }
    
    .container {
      max-width: 1000px;
      background: white;
    }
    
    h1 {
      color: #333;
      text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
    }
    
    .input-row {
      margin-bottom: 1.5em;
    }
    
    .label-hint {
      font-weight: normal;
      color: #666;
      font-size: 0.9em;
      margin-left: 0.5em;
    }
    
    .input-group-inline {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1em;
    }
    
    .summary-overview {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2em;
      border-radius: 10px;
      margin-bottom: 2em;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .summary-overview h2 {
      margin-top: 0;
      color: white;
      border: none;
      text-align: center;
      margin-bottom: 1.5em;
    }
    
    .big-number {
      font-size: 2.5em;
      font-weight: bold;
      text-align: center;
      margin: 0.5em 0;
      color: white;
    }
    
    .summary-subtitle {
      font-size: 1.1em;
      text-align: center;
      margin-bottom: 1.5em;
      color: white;
      opacity: 0.95;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1em;
    }
    
    .stat-box {
      background: rgba(255,255,255,0.2);
      padding: 1em;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
      margin-bottom: 0.5em;
    }
    
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
    }
    
    .insight-box {
      background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 100%);
      color: white;
      padding: 1.5em;
      border-radius: 10px;
      margin-bottom: 2em;
    }
    
    .insight-box h3 {
      margin-top: 0;
      color: white;
      border: none;
    }
    
    .insight-item {
      background: rgba(255,255,255,0.2);
      padding: 1em;
      border-radius: 8px;
      margin-bottom: 1em;
    }
    
    .insight-item:last-child {
      margin-bottom: 0;
    }
    
    .insight-title {
      font-weight: bold;
      margin-bottom: 0.5em;
      font-size: 1.1em;
    }
    
    .insight-desc {
      opacity: 0.95;
      line-height: 1.6;
    }
    
    .hidden {
      display: none;
    }
    
    .table-container {
      max-height: 500px;
      overflow-y: auto;
    }
    
    th, td {
      text-align: center;
    }
    
    .highlight-row {
      background: #fff9e6 !important;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .input-group-inline {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .big-number {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ´ é€€ä¼‘ç”Ÿæ´»è²»è¨ˆç®—å·¥å…·</h1>

    <div class="input-group">
      <div class="info-box">
        <p>ğŸ“Œ æ­¤å·¥å…·å¯å¹«æ‚¨è¨ˆç®—é€€ä¼‘æ‰€éœ€è³‡é‡‘ï¼Œè€ƒæ…®é€šè²¨è†¨è„¹å› ç´ ï¼Œè¦åŠƒå®‰ç©©çš„é€€ä¼‘ç”Ÿæ´»</p>
      </div>

      <div class="input-group-inline">
        <div class="input-row">
          <label>
            ç›®å‰å¹´é½¡:
            <span class="label-hint">æ­²</span>
          </label>
          <input type="number" id="currentAge" placeholder="ä¾‹å¦‚ï¼š30" value="30" min="18" max="100">
        </div>
        
        <div class="input-row">
          <label>
            é è¨ˆé€€ä¼‘å¹´é½¡:
            <span class="label-hint">æ­²</span>
          </label>
          <input type="number" id="retirementAge" placeholder="ä¾‹å¦‚ï¼š65" value="65" min="18" max="100">
        </div>
      </div>

      <div class="input-group-inline">
        <div class="input-row">
          <label>
            æ¯æœˆç”Ÿæ´»è²»ï¼ˆå…ƒï¼‰:
            <span class="label-hint">ä»¥ç¾åœ¨çš„ç‰©åƒ¹æ°´æº–</span>
          </label>
          <input type="number" id="monthlyExpense" placeholder="ä¾‹å¦‚ï¼š30000" value="30000">
        </div>
        
        <div class="input-row">
          <label>
            é æœŸé€€ä¼‘å¹´æ•¸:
            <span class="label-hint">é€€ä¼‘å¾Œç”Ÿæ´»çš„å¹´æ•¸</span>
          </label>
          <input type="number" id="retirementYears" placeholder="ä¾‹å¦‚ï¼š25" value="25" min="1">
        </div>
      </div>

      <div class="input-group-inline">
        <div class="input-row">
          <label>
            å¹´é€šè²¨è†¨è„¹ç‡ï¼ˆ%ï¼‰:
            <span class="label-hint">å°ç£å¹³å‡ç´„ 1.5-2%</span>
          </label>
          <input type="number" id="inflationRate" placeholder="ä¾‹å¦‚ï¼š2" value="2" step="0.1">
        </div>
        
        <div class="input-row">
          <label>
            æŠ•è³‡å ±é…¬ç‡ï¼ˆ%ï¼‰:
            <span class="label-hint">é€€ä¼‘é‡‘æŠ•è³‡å¹´å ±é…¬ç‡</span>
          </label>
          <input type="number" id="returnRate" placeholder="ä¾‹å¦‚ï¼š4" value="4" step="0.1">
        </div>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="calculate()">é–‹å§‹è¨ˆç®—</button>
        <button class="btn-secondary hidden" id="downloadBtn" onclick="downloadCSV()">ä¸‹è¼‰çµæœï¼ˆCSVï¼‰</button>
      </div>
    </div>

    <div class="hidden" id="result">
      <div class="summary-overview">
        <h2>ğŸ¯ é€€ä¼‘è³‡é‡‘éœ€æ±‚</h2>
        <div class="big-number" id="totalNeeded">-</div>
        <div class="summary-subtitle">é€€ä¼‘æ™‚éœ€æº–å‚™çš„ç¸½é‡‘é¡</div>
        
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">è·é›¢é€€ä¼‘</div>
            <div class="stat-value" id="yearsToRetirement">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">é€€ä¼‘ç¬¬ä¸€å¹´æœˆç”Ÿæ´»è²»</div>
            <div class="stat-value" id="firstYearExpense">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">é€€ä¼‘æœŸé–“ç¸½æ”¯å‡º</div>
            <div class="stat-value" id="totalExpense">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">æ¯æœˆæ‡‰å­˜é‡‘é¡</div>
            <div class="stat-value" id="monthlySaving">-</div>
          </div>
        </div>
      </div>

      <div class="insight-box">
        <h3>ğŸ’¡ ç†è²¡å»ºè­°</h3>
        <div class="insight-item">
          <div class="insight-title">ğŸ¯ å„²è“„ç›®æ¨™</div>
          <div class="insight-desc" id="savingGoal">-</div>
        </div>
        <div class="insight-item">
          <div class="insight-title">ğŸ“Š æŠ•è³‡ç­–ç•¥</div>
          <div class="insight-desc" id="investmentStrategy">-</div>
        </div>
        <div class="insight-item">
          <div class="insight-title">âš ï¸ é¢¨éšªæé†’</div>
          <div class="insight-desc" id="riskWarning">-</div>
        </div>
      </div>

      <h3 style="color: #333;">ğŸ“ˆ é€€ä¼‘ç”Ÿæ´»è²»é€å¹´æ˜ç´°</h3>
      <div class="table-container">
        <table id="resultTable">
          <thead>
            <tr>
              <th>é€€ä¼‘å¹´æ•¸</th>
              <th>å¹´é½¡</th>
              <th>æ¯æœˆç”Ÿæ´»è²»ï¼ˆå…ƒï¼‰</th>
              <th>å¹´åº¦æ”¯å‡ºï¼ˆå…ƒï¼‰</th>
              <th>ç´¯è¨ˆæ”¯å‡ºï¼ˆå…ƒï¼‰</th>
              <th>å‰©é¤˜è³‡é‡‘ï¼ˆå…ƒï¼‰</th>
            </tr>
          </thead>
          <tbody id="resultBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let cachedData = [];

    function calculate() {
      const currentAge = parseInt(document.getElementById('currentAge').value);
      const retirementAge = parseInt(document.getElementById('retirementAge').value);
      const monthlyExpense = parseFloat(document.getElementById('monthlyExpense').value);
      const retirementYears = parseInt(document.getElementById('retirementYears').value);
      const inflationRate = parseFloat(document.getElementById('inflationRate').value) / 100;
      const returnRate = parseFloat(document.getElementById('returnRate').value) / 100;

      if (isNaN(currentAge) || isNaN(retirementAge) || isNaN(monthlyExpense) || 
          isNaN(retirementYears) || isNaN(inflationRate) || isNaN(returnRate)) {
        alert('è«‹è¼¸å…¥æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
        return;
      }

      if (retirementAge <= currentAge) {
        alert('é€€ä¼‘å¹´é½¡å¿…é ˆå¤§æ–¼ç›®å‰å¹´é½¡ï¼');
        return;
      }

      if (monthlyExpense <= 0 || retirementYears <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡å’Œå¹´æ•¸ï¼');
        return;
      }

      const yearsToRetirement = retirementAge - currentAge;

      // è¨ˆç®—é€€ä¼‘æ™‚ï¼ˆç¬¬ä¸€å¹´ï¼‰çš„æœˆç”Ÿæ´»è²»ï¼ˆè€ƒæ…®é€šè†¨ï¼‰
      const firstYearMonthlyExpense = monthlyExpense * Math.pow(1 + inflationRate, yearsToRetirement);
      
      // è¨ˆç®—é€€ä¼‘æœŸé–“æ¯å¹´çš„æ”¯å‡ºå’Œæ‰€éœ€è³‡é‡‘
      cachedData = [];
      let cumulativeExpense = 0;
      let totalExpense = 0;

      // å…ˆè¨ˆç®—ç¸½æ”¯å‡ºï¼ˆè€ƒæ…®é€šè†¨ï¼‰
      for (let year = 1; year <= retirementYears; year++) {
        const age = retirementAge + year - 1;
        const monthlyExp = firstYearMonthlyExpense * Math.pow(1 + inflationRate, year - 1);
        const yearlyExp = monthlyExp * 12;
        totalExpense += yearlyExp;
      }

      // è¨ˆç®—éœ€è¦æº–å‚™çš„é€€ä¼‘é‡‘ç¸½é¡ï¼ˆè€ƒæ…®æŠ•è³‡å ±é…¬ï¼‰
      let totalNeeded = 0;
      let remainingFunds = 0;

      // ä½¿ç”¨å¹´é‡‘ç¾å€¼å…¬å¼è¨ˆç®—æ‰€éœ€è³‡é‡‘
      // è€ƒæ…®é€šè†¨å’ŒæŠ•è³‡å ±é…¬çš„å¯¦éš›å ±é…¬ç‡
      const realReturnRate = (1 + returnRate) / (1 + inflationRate) - 1;
      
      if (Math.abs(realReturnRate) < 0.0001) {
        // å¦‚æœå¯¦éš›å ±é…¬ç‡æ¥è¿‘0ï¼Œä½¿ç”¨ç°¡å–®ç¸½å’Œ
        totalNeeded = firstYearMonthlyExpense * 12 * retirementYears;
      } else {
        // ä½¿ç”¨æˆé•·å¹´é‡‘ç¾å€¼å…¬å¼
        const firstYearExpense = firstYearMonthlyExpense * 12;
        totalNeeded = firstYearExpense * (1 - Math.pow(1 + inflationRate, retirementYears) / Math.pow(1 + returnRate, retirementYears)) / (returnRate - inflationRate);
      }

      remainingFunds = totalNeeded;

      // ç”Ÿæˆæ¯å¹´æ˜ç´°
      cumulativeExpense = 0;
      for (let year = 1; year <= retirementYears; year++) {
        const age = retirementAge + year - 1;
        const monthlyExp = firstYearMonthlyExpense * Math.pow(1 + inflationRate, year - 1);
        const yearlyExp = monthlyExp * 12;
        
        // è¨ˆç®—è©²å¹´åº¦é–‹å§‹æ™‚çš„è³‡é‡‘ï¼ˆå‰ä¸€å¹´å‰©é¤˜è³‡é‡‘æŠ•è³‡æˆé•·ï¼‰
        if (year > 1) {
          remainingFunds = remainingFunds * (1 + returnRate);
        }
        
        // æ‰£é™¤è©²å¹´åº¦æ”¯å‡º
        remainingFunds -= yearlyExp;
        cumulativeExpense += yearlyExp;

        cachedData.push({
          year: year,
          age: age,
          monthlyExpense: Math.round(monthlyExp),
          yearlyExpense: Math.round(yearlyExp),
          cumulativeExpense: Math.round(cumulativeExpense),
          remainingFunds: Math.round(remainingFunds)
        });
      }

      // è¨ˆç®—æ¯æœˆæ‡‰å­˜é‡‘é¡ï¼ˆä½¿ç”¨å®šæœŸå®šé¡å…¬å¼ï¼‰
      const monthsToRetirement = yearsToRetirement * 12;
      const monthlyReturnRate = Math.pow(1 + returnRate, 1/12) - 1;
      let monthlySaving = 0;
      
      if (monthlyReturnRate > 0.0001) {
        monthlySaving = totalNeeded * monthlyReturnRate / (Math.pow(1 + monthlyReturnRate, monthsToRetirement) - 1);
      } else {
        monthlySaving = totalNeeded / monthsToRetirement;
      }

      // æ›´æ–°ç¸½è¦½
      document.getElementById('totalNeeded').textContent = '$ ' + Math.round(totalNeeded).toLocaleString('zh-TW');
      document.getElementById('yearsToRetirement').textContent = yearsToRetirement + ' å¹´';
      document.getElementById('firstYearExpense').textContent = Math.round(firstYearMonthlyExpense).toLocaleString('zh-TW') + ' å…ƒ';
      document.getElementById('totalExpense').textContent = Math.round(totalExpense).toLocaleString('zh-TW') + ' å…ƒ';
      document.getElementById('monthlySaving').textContent = Math.round(monthlySaving).toLocaleString('zh-TW') + ' å…ƒ';

      // æ›´æ–°ç†è²¡å»ºè­°
      const savingGoalText = `å¾ç¾åœ¨åˆ°é€€ä¼‘å‰ï¼Œæ‚¨éœ€è¦ç´¯ç© ${Math.round(totalNeeded).toLocaleString('zh-TW')} å…ƒã€‚å»ºè­°æ¯æœˆå›ºå®šå„²è“„ ${Math.round(monthlySaving).toLocaleString('zh-TW')} å…ƒï¼Œä¸¦æŠ•è³‡æ–¼å¹´å ±é…¬ç‡ç´„ ${(returnRate * 100).toFixed(1)}% çš„æ¨™çš„ã€‚`;
      document.getElementById('savingGoal').textContent = savingGoalText;

      const investmentStrategyText = `å»ºè­°æ¡å–åˆ†æ•£æŠ•è³‡ç­–ç•¥ï¼šè‚¡ç¥¨å‹åŸºé‡‘ ${returnRate >= 0.05 ? '60%' : '40%'}ã€å‚µåˆ¸å‹åŸºé‡‘ ${returnRate >= 0.05 ? '30%' : '40%'}ã€ç¾é‡‘æˆ–å®šå­˜ ${returnRate >= 0.05 ? '10%' : '20%'}ã€‚éš¨è‘—æ¥è¿‘é€€ä¼‘å¹´é½¡ï¼Œé€æ­¥é™ä½è‚¡ç¥¨æ¯”é‡ï¼Œæé«˜å‚µåˆ¸å’Œç¾é‡‘æ¯”é‡ã€‚`;
      document.getElementById('investmentStrategy').textContent = investmentStrategyText;

      const riskWarningText = `é€šè²¨è†¨è„¹æœƒæŒçºŒä¾µè•è³¼è²·åŠ›ï¼Œå»ºè­°æ¯å¹´æª¢è¦–é€€ä¼‘è¨ˆç•«ä¸¦é©æ™‚èª¿æ•´ã€‚é†«ç™‚è²»ç”¨é€šå¸¸æœƒéš¨å¹´é½¡å¢åŠ ï¼Œå»ºè­°é¡å¤–é ç•™ 20-30% çš„ç·Šæ€¥æº–å‚™é‡‘ã€‚è‹¥æŠ•è³‡å ±é…¬ç‡ä½æ–¼é æœŸï¼Œå¯èƒ½éœ€è¦å»¶å¾Œé€€ä¼‘å¹´é½¡æˆ–æé«˜å„²è“„é‡‘é¡ã€‚`;
      document.getElementById('riskWarning').textContent = riskWarningText;

      // ç”Ÿæˆè¡¨æ ¼
      let tableRows = '';
      cachedData.forEach((data, index) => {
        const rowClass = data.remainingFunds < 0 ? 'highlight-row' : '';
        tableRows += `
          <tr class="${rowClass}">
            <td><strong>ç¬¬ ${data.year} å¹´</strong></td>
            <td>${data.age} æ­²</td>
            <td>${data.monthlyExpense.toLocaleString('zh-TW')}</td>
            <td>${data.yearlyExpense.toLocaleString('zh-TW')}</td>
            <td>${data.cumulativeExpense.toLocaleString('zh-TW')}</td>
            <td>${data.remainingFunds.toLocaleString('zh-TW')}</td>
          </tr>
        `;
      });

      document.getElementById('resultBody').innerHTML = tableRows;

      // é¡¯ç¤ºçµæœ
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('downloadBtn').classList.remove('hidden');
    }

    function downloadCSV() {
      if (cachedData.length === 0) {
        alert('è«‹å…ˆè¨ˆç®—çµæœ');
        return;
      }

      const currentAge = parseInt(document.getElementById('currentAge').value);
      const retirementAge = parseInt(document.getElementById('retirementAge').value);
      const monthlyExpense = parseFloat(document.getElementById('monthlyExpense').value);
      const retirementYears = parseInt(document.getElementById('retirementYears').value);
      const inflationRate = parseFloat(document.getElementById('inflationRate').value);
      const returnRate = parseFloat(document.getElementById('returnRate').value);

      let csvContent = '\uFEFF'; // UTF-8 BOM
      csvContent += 'é€€ä¼‘ç”Ÿæ´»è²»è¨ˆç®—çµæœ\n';
      csvContent += `ç›®å‰å¹´é½¡,${currentAge}\n`;
      csvContent += `é€€ä¼‘å¹´é½¡,${retirementAge}\n`;
      csvContent += `ç›®å‰æ¯æœˆç”Ÿæ´»è²»,${monthlyExpense}\n`;
      csvContent += `é æœŸé€€ä¼‘å¹´æ•¸,${retirementYears}\n`;
      csvContent += `é€šè²¨è†¨è„¹ç‡,${inflationRate}%\n`;
      csvContent += `æŠ•è³‡å ±é…¬ç‡,${returnRate}%\n\n`;
      csvContent += 'é€€ä¼‘å¹´æ•¸,å¹´é½¡,æ¯æœˆç”Ÿæ´»è²»ï¼ˆå…ƒï¼‰,å¹´åº¦æ”¯å‡ºï¼ˆå…ƒï¼‰,ç´¯è¨ˆæ”¯å‡ºï¼ˆå…ƒï¼‰,å‰©é¤˜è³‡é‡‘ï¼ˆå…ƒï¼‰\n';
      
      cachedData.forEach(data => {
        csvContent += `ç¬¬${data.year}å¹´,${data.age},${data.monthlyExpense},${data.yearlyExpense},${data.cumulativeExpense},${data.remainingFunds}\n`;
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.setAttribute('href', URL.createObjectURL(blob));
      link.setAttribute('download', 'é€€ä¼‘ç”Ÿæ´»è²»è¨ˆç®—çµæœ.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // æŒ‰ Enter éµä¹Ÿå¯ä»¥è¨ˆç®—
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        calculate();
      }
    });
  </script>
</body>
</html>
