<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ¶ˆè²»æ€§è²¸æ¬¾è¨ˆç®—å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="common-styles.css">
  <style>
    /* é é¢ç‰¹å®šæ¨£å¼ */
    body {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    }
    
    .container {
      max-width: 1000px;
      background: white;
    }
    
    h1 {
      color: #333;
      text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
    }
    
    .input-row {
      margin-bottom: 1.5em;
    }
    
    .label-hint {
      font-weight: normal;
      color: #666;
      font-size: 0.9em;
      margin-left: 0.5em;
    }
    
    .input-group-inline {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1em;
    }
    
    .summary-overview {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 2em;
      border-radius: 10px;
      margin-bottom: 2em;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .summary-overview h2 {
      margin-top: 0;
      color: white;
      border: none;
      text-align: center;
      margin-bottom: 1.5em;
    }
    
    .big-number {
      font-size: 2.5em;
      font-weight: bold;
      text-align: center;
      margin: 0.5em 0;
      color: white;
    }
    
    .summary-subtitle {
      font-size: 1.1em;
      text-align: center;
      margin-bottom: 1.5em;
      color: white;
      opacity: 0.95;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1em;
    }
    
    .stat-box {
      background: rgba(255,255,255,0.2);
      padding: 1em;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
      margin-bottom: 0.5em;
    }
    
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
    }
    
    .loan-info-box {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      padding: 1.5em;
      border-radius: 10px;
      margin-bottom: 2em;
    }
    
    .loan-info-box h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #fcb69f;
      padding-bottom: 0.5em;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1em;
      margin-top: 1em;
    }
    
    .info-item {
      background: white;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .info-label {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 0.3em;
    }
    
    .info-value {
      font-size: 1.3em;
      font-weight: bold;
      color: #f5576c;
    }
    
    .hidden {
      display: none;
    }
    
    .table-container {
      max-height: 500px;
      overflow-y: auto;
    }
    
    th, td {
      text-align: center;
    }
    
    @media (max-width: 768px) {
      .input-group-inline,
      .info-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .big-number {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’³ æ¶ˆè²»æ€§è²¸æ¬¾è¨ˆç®—å·¥å…·</h1>

    <div class="input-group">
      <div class="info-box">
        <p>ğŸ“Œ æ­¤å·¥å…·å¯å¹«æ‚¨è©¦ç®—æ¶ˆè²»æ€§è²¸æ¬¾çš„æ¯æœˆé‚„æ¬¾é‡‘é¡ã€ç¸½åˆ©æ¯èˆ‡ç¸½é‚„æ¬¾é‡‘é¡</p>
      </div>

      <div class="input-row">
        <label>
          è²¸æ¬¾ç¸½é¡ï¼ˆå…ƒï¼‰:
          <span class="label-hint">éœ€è¦å€Ÿè²¸çš„é‡‘é¡</span>
        </label>
        <input type="number" id="loanAmount" placeholder="ä¾‹å¦‚ï¼š500000" value="500000">
      </div>

      <div class="input-row">
        <label>
          å¹´åˆ©ç‡ï¼ˆ%ï¼‰:
          <span class="label-hint">éŠ€è¡Œæä¾›çš„è²¸æ¬¾åˆ©ç‡</span>
        </label>
        <input type="number" id="interestRate" placeholder="ä¾‹å¦‚ï¼š3.5" value="3.5" step="0.01">
      </div>

      <div class="input-row">
        <label>è²¸æ¬¾æœŸæ•¸:</label>
        <div class="input-group-inline">
          <div>
            <input type="number" id="loanYears" placeholder="å¹´æ•¸" value="5" min="0">
            <span class="label-hint">å¹´</span>
          </div>
          <div>
            <input type="number" id="loanMonths" placeholder="æœˆæ•¸" value="0" min="0" max="11">
            <span class="label-hint">æœˆï¼ˆ0-11ï¼‰</span>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="calculate()">é–‹å§‹è©¦ç®—</button>
        <button class="btn-secondary hidden" id="downloadBtn" onclick="downloadCSV()">ä¸‹è¼‰çµæœï¼ˆCSVï¼‰</button>
      </div>
    </div>

    <div class="hidden" id="result">
      <div class="summary-overview">
        <h2>ğŸ¯ è²¸æ¬¾è©¦ç®—çµæœ</h2>
        <div class="big-number" id="monthlyPayment">-</div>
        <div class="summary-subtitle">æ¯æœˆæ‡‰ç¹³é‡‘é¡ï¼ˆæœ¬æ¯å¹³å‡æ”¤é‚„ï¼‰</div>
        
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">è²¸æ¬¾ç¸½é¡</div>
            <div class="stat-value" id="displayLoanAmount">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">ç¸½åˆ©æ¯</div>
            <div class="stat-value" id="totalInterest">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">ç¸½é‚„æ¬¾é‡‘é¡</div>
            <div class="stat-value" id="totalPayment">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">è²¸æ¬¾æœŸæ•¸</div>
            <div class="stat-value" id="loanPeriod">-</div>
          </div>
        </div>
      </div>

      <div class="loan-info-box">
        <h3>ğŸ“Š è²¸æ¬¾è³‡è¨Šæ‘˜è¦</h3>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">é¦–æœŸé‚„æ¬¾</div>
            <div class="info-value" id="firstPayment">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">é¦–æœŸæœ¬é‡‘</div>
            <div class="info-value" id="firstPrincipal">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">é¦–æœŸåˆ©æ¯</div>
            <div class="info-value" id="firstInterest">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">åˆ©æ¯ä½”æ¯”</div>
            <div class="info-value" id="interestRatio">-</div>
          </div>
        </div>
      </div>

      <h3 style="color: #333;">ğŸ“ˆ é‚„æ¬¾æ˜ç´°è¡¨</h3>
      <div class="table-container">
        <table id="resultTable">
          <thead>
            <tr>
              <th>æœŸæ•¸</th>
              <th>æœ¬é‡‘ï¼ˆå…ƒï¼‰</th>
              <th>åˆ©æ¯ï¼ˆå…ƒï¼‰</th>
              <th>æœˆä»˜é‡‘ï¼ˆå…ƒï¼‰</th>
              <th>å‰©é¤˜æœ¬é‡‘ï¼ˆå…ƒï¼‰</th>
            </tr>
          </thead>
          <tbody id="resultBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let cachedData = [];

    function calculate() {
      const loanAmount = parseFloat(document.getElementById('loanAmount').value);
      const interestRate = parseFloat(document.getElementById('interestRate').value);
      const loanYears = parseInt(document.getElementById('loanYears').value) || 0;
      const loanMonths = parseInt(document.getElementById('loanMonths').value) || 0;

      if (isNaN(loanAmount) || isNaN(interestRate) || loanAmount <= 0 || interestRate < 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è²¸æ¬¾é‡‘é¡å’Œåˆ©ç‡ï¼');
        return;
      }

      const totalMonths = loanYears * 12 + loanMonths;
      if (totalMonths <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è²¸æ¬¾æœŸæ•¸ï¼');
        return;
      }

      // è¨ˆç®—æœˆåˆ©ç‡
      const monthlyRate = interestRate / 100 / 12;

      // è¨ˆç®—æ¯æœˆæ‡‰ç¹³é‡‘é¡ï¼ˆæœ¬æ¯å¹³å‡æ”¤é‚„ï¼‰
      let monthlyPayment;
      if (monthlyRate > 0) {
        monthlyPayment = loanAmount * monthlyRate * Math.pow(1 + monthlyRate, totalMonths) / 
                        (Math.pow(1 + monthlyRate, totalMonths) - 1);
      } else {
        // åˆ©ç‡ç‚º0çš„æƒ…æ³
        monthlyPayment = loanAmount / totalMonths;
      }

      // è¨ˆç®—é‚„æ¬¾æ˜ç´°
      cachedData = [];
      let remainingPrincipal = loanAmount;
      let totalInterestPaid = 0;

      for (let month = 1; month <= totalMonths; month++) {
        const interest = remainingPrincipal * monthlyRate;
        const principal = monthlyPayment - interest;
        remainingPrincipal -= principal;
        totalInterestPaid += interest;

        cachedData.push({
          month: month,
          principal: Math.round(principal),
          interest: Math.round(interest),
          payment: Math.round(monthlyPayment),
          remaining: Math.round(Math.max(0, remainingPrincipal))
        });
      }

      const totalPayment = loanAmount + totalInterestPaid;
      const interestRatio = (totalInterestPaid / totalPayment * 100).toFixed(1);

      // æ›´æ–°ç¸½è¦½
      document.getElementById('monthlyPayment').textContent = '$ ' + Math.round(monthlyPayment).toLocaleString('zh-TW');
      document.getElementById('displayLoanAmount').textContent = loanAmount.toLocaleString('zh-TW') + ' å…ƒ';
      document.getElementById('totalInterest').textContent = Math.round(totalInterestPaid).toLocaleString('zh-TW') + ' å…ƒ';
      document.getElementById('totalPayment').textContent = Math.round(totalPayment).toLocaleString('zh-TW') + ' å…ƒ';
      document.getElementById('loanPeriod').textContent = `${loanYears}å¹´${loanMonths}æœˆ`;

      // æ›´æ–°è²¸æ¬¾è³‡è¨Šæ‘˜è¦
      document.getElementById('firstPayment').textContent = cachedData[0].payment.toLocaleString('zh-TW') + ' å…ƒ';
      document.getElementById('firstPrincipal').textContent = cachedData[0].principal.toLocaleString('zh-TW') + ' å…ƒ';
      document.getElementById('firstInterest').textContent = cachedData[0].interest.toLocaleString('zh-TW') + ' å…ƒ';
      document.getElementById('interestRatio').textContent = interestRatio + ' %';

      // ç”Ÿæˆè¡¨æ ¼ï¼ˆé¡¯ç¤ºæ‰€æœ‰æœŸæ•¸ï¼‰
      let tableRows = '';
      
      cachedData.forEach((data) => {
        tableRows += `
          <tr>
            <td><strong>${data.month}</strong></td>
            <td>${data.principal.toLocaleString('zh-TW')}</td>
            <td>${data.interest.toLocaleString('zh-TW')}</td>
            <td><strong>${data.payment.toLocaleString('zh-TW')}</strong></td>
            <td>${data.remaining.toLocaleString('zh-TW')}</td>
          </tr>
        `;
      });

      document.getElementById('resultBody').innerHTML = tableRows;

      // é¡¯ç¤ºçµæœ
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('downloadBtn').classList.remove('hidden');
    }

    function downloadCSV() {
      if (cachedData.length === 0) {
        alert('è«‹å…ˆè¨ˆç®—çµæœ');
        return;
      }

      const loanAmount = parseFloat(document.getElementById('loanAmount').value);
      const interestRate = parseFloat(document.getElementById('interestRate').value);
      const loanYears = parseInt(document.getElementById('loanYears').value) || 0;
      const loanMonths = parseInt(document.getElementById('loanMonths').value) || 0;
      const totalInterest = cachedData.reduce((sum, data) => sum + data.interest, 0);
      const totalPayment = loanAmount + totalInterest;

      let csvContent = '\uFEFF'; // UTF-8 BOM
      csvContent += 'æ¶ˆè²»æ€§è²¸æ¬¾è¨ˆç®—çµæœ\n';
      csvContent += `è²¸æ¬¾ç¸½é¡,${loanAmount}\n`;
      csvContent += `å¹´åˆ©ç‡,${interestRate}%\n`;
      csvContent += `è²¸æ¬¾æœŸæ•¸,${loanYears}å¹´${loanMonths}æœˆ\n`;
      csvContent += `æ¯æœˆæ‡‰ç¹³é‡‘é¡,${cachedData[0].payment}\n`;
      csvContent += `ç¸½åˆ©æ¯,${Math.round(totalInterest)}\n`;
      csvContent += `ç¸½é‚„æ¬¾é‡‘é¡,${Math.round(totalPayment)}\n\n`;
      csvContent += 'æœŸæ•¸,æœ¬é‡‘ï¼ˆå…ƒï¼‰,åˆ©æ¯ï¼ˆå…ƒï¼‰,æœˆä»˜é‡‘ï¼ˆå…ƒï¼‰,å‰©é¤˜æœ¬é‡‘ï¼ˆå…ƒï¼‰\n';
      
      cachedData.forEach(data => {
        csvContent += `${data.month},${data.principal},${data.interest},${data.payment},${data.remaining}\n`;
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.setAttribute('href', URL.createObjectURL(blob));
      link.setAttribute('download', 'æ¶ˆè²»æ€§è²¸æ¬¾è¨ˆç®—çµæœ.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // æŒ‰ Enter éµä¹Ÿå¯ä»¥è¨ˆç®—
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        calculate();
      }
    });
  </script>
</body>
</html>
