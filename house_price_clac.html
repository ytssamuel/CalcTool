<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æˆ¿åƒ¹æŠ˜ç®—è©¦ç®—å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <link rel="stylesheet" href="common-styles.css">
  <style>
    /* é é¢ç‰¹å®šæ¨£å¼ */
    .container {
      max-width: 1000px;
    }
    
    .input-row {
      margin-bottom: 1.5em;
    }
    
    .label-hint {
      font-weight: normal;
      color: #666;
      font-size: 0.9em;
      margin-left: 0.5em;
    }
    
    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2em;
      border-radius: 10px;
      margin: 2em 0;
      text-align: center;
    }
    
    .summary-card h3 {
      margin: 0 0 0.5em 0;
      color: white;
      border: none;
    }
    
    .big-number {
      font-size: 2.5em;
      font-weight: bold;
      margin: 0.5em 0;
    }
    
    .chart-container {
      background: white;
      padding: 2em;
      border-radius: 10px;
      margin: 2em 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .chart-title {
      text-align: center;
      color: #333;
      margin-bottom: 1.5em;
      font-size: 1.3em;
    }
    
    .bar-chart {
      display: flex;
      flex-direction: column;
      gap: 1em;
    }
    
    .bar-item {
      display: flex;
      align-items: center;
      gap: 1em;
    }
    
    .bar-label {
      width: 100px;
      font-weight: bold;
      color: #555;
      font-size: 0.9em;
      text-align: right;
    }
    
    .bar-wrapper {
      flex: 1;
      position: relative;
    }
    
    .bar {
      height: 40px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 1em;
      color: white;
      font-weight: bold;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .bar:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .bar-value {
      font-size: 1em;
    }
    
    .line-chart {
      width: 100%;
      min-height: 300px;
      position: relative;
      margin-top: 1em;
    }
    
    .line-chart svg {
      display: block;
      max-width: 100%;
    }
    
    .hidden {
      display: none;
    }
    
    th, td {
      text-align: center;
    }
    
    .highlight-row {
      background: #e3f2fd !important;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .bar-label {
        width: 80px;
        font-size: 0.8em;
      }
      
      .big-number {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ˜ï¸ æˆ¿åƒ¹æŠ˜ç®—è©¦ç®—å·¥å…·</h1>

    <div class="input-group">
      <div class="info-box">
        <p>ğŸ“Œ è¼¸å…¥æˆ¿å±‹è³‡è¨Šï¼Œè‡ªå‹•è¨ˆç®—ä¸åŒå±‹é½¡ä¸‹çš„æŠ˜ç®—åƒ¹æ ¼èˆ‡åœ–è¡¨åˆ†æ</p>
      </div>

      <div class="input-row">
        <label>
          æˆ¿å±‹ç¸½åƒ¹ï¼ˆè¬å…ƒï¼‰:
          <span class="label-hint">ä¾‹å¦‚ï¼š2400 è¬å…ƒ</span>
        </label>
        <input type="number" id="totalPrice" placeholder="ä¾‹å¦‚ï¼š2400" value="2400">
      </div>

      <div class="input-row">
        <label>
          åªæ•¸:
          <span class="label-hint">å»ºç‰©åªæ•¸</span>
        </label>
        <input type="number" id="totalPings" placeholder="ä¾‹å¦‚ï¼š30" value="30" step="0.1">
      </div>

      <div class="input-row">
        <label>
          å±‹é½¡ï¼ˆå¹´ï¼‰:
          <span class="label-hint">0 = é å”®å±‹ï¼Œ50+ = è€å±‹</span>
        </label>
        <input type="number" id="houseAge" placeholder="ä¾‹å¦‚ï¼š10" value="10" min="0" max="60">
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="calculateBackwards()">é–‹å§‹è¨ˆç®—</button>
        <button class="btn-secondary hidden" id="downloadBtn" onclick="downloadCSV()">ä¸‹è¼‰çµæœï¼ˆCSVï¼‰</button>
      </div>
    </div>

    <div class="hidden" id="result">
      <div class="summary-card">
        <h3>ğŸ¯ æ¨ç®—åŸå§‹å–®åªåƒ¹æ ¼</h3>
        <div class="big-number" id="originalPrice">-</div>
        <p style="margin: 0; opacity: 0.9;">è¬å…ƒ/åª</p>
      </div>

      <div class="chart-container">
        <h3 class="chart-title">ğŸ“Š ä¸åŒå±‹é½¡æŠ˜ç®—å–®åªåƒ¹æ ¼</h3>
        <div class="bar-chart" id="barChart"></div>
      </div>

      <div class="chart-container">
        <h3 class="chart-title">ğŸ“ˆ æˆ¿åƒ¹æŠ˜èˆŠè¶¨å‹¢åœ–</h3>
        <div class="line-chart" id="lineChart"></div>
      </div>

      <h3 style="color: #333; margin-top: 2em;">ğŸ“‹ è©³ç´°æŠ˜ç®—è¡¨</h3>
      <div style="overflow-x: auto;">
        <table id="resultTable">
          <thead>
            <tr>
              <th>å±‹é½¡</th>
              <th>æŠ˜èˆŠç‡</th>
              <th>æŠ˜ç®—å–®åªåƒ¹æ ¼ï¼ˆè¬ï¼‰</th>
              <th>æŠ˜ç®—ç¸½åƒ¹ï¼ˆè¬ï¼‰</th>
            </tr>
          </thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let cachedData = [];

    // è¨ˆç®—æŠ˜èˆŠä¿‚æ•¸ï¼šç·šæ€§éæ¸›ï¼Œå¾ 100% (é å”®å±‹) åˆ° 60% (50å¹´ä»¥ä¸Šè€å±‹)
    function getDepreciationFactor(age) {
      if (age <= 0) return 1.0; // é å”®å±‹ 100%
      if (age >= 50) return 0.6; // 50å¹´ä»¥ä¸Š 60%
      // ç·šæ€§éæ¸›ï¼šæ¯å¹´éæ¸› 0.8%
      return 1.0 - (age * 0.008);
    }

    function calculateBackwards() {
      const totalPrice = parseFloat(document.getElementById('totalPrice').value);
      const totalPings = parseFloat(document.getElementById('totalPings').value);
      const houseAge = parseInt(document.getElementById('houseAge').value);

      if (isNaN(totalPrice) || isNaN(totalPings) || isNaN(houseAge) || totalPings === 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼ï¼');
        return;
      }

      const currentPerPing = totalPrice / totalPings;
      const currentFactor = getDepreciationFactor(houseAge);
      const originalPerPing = currentPerPing / currentFactor;

      // é¡¯ç¤ºåŸå§‹å–®åªåƒ¹æ ¼
      document.getElementById('originalPrice').textContent = originalPerPing.toFixed(2);

      // ç”Ÿæˆä¸åŒå±‹é½¡çš„æ•¸æ“š
      cachedData = [];
      const ages = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50];
      
      for (const age of ages) {
        const factor = getDepreciationFactor(age);
        const adjustedPerPing = originalPerPing * factor;
        const adjustedTotalPrice = adjustedPerPing * totalPings;
        const isCurrentAge = age === houseAge;
        
        cachedData.push({
          age: age,
          factor: factor,
          perPing: adjustedPerPing.toFixed(2),
          total: adjustedTotalPrice.toFixed(2),
          isCurrent: isCurrentAge
        });
      }

      // ç”Ÿæˆè¡¨æ ¼
      let tableRows = '';
      cachedData.forEach(row => {
        const rowClass = row.isCurrent ? 'class="highlight-row"' : '';
        const ageLabel = row.age === 0 ? 'é å”®å±‹' : `${row.age} å¹´`;
        tableRows += `
          <tr ${rowClass}>
            <td>${ageLabel}</td>
            <td>${(row.factor * 100).toFixed(1)}%</td>
            <td>${row.perPing}</td>
            <td>${row.total}</td>
          </tr>
        `;
      });
      document.getElementById('resultBody').innerHTML = tableRows;

      // ç”Ÿæˆé•·æ¢åœ–
      generateBarChart(cachedData, houseAge);

      // ç”ŸæˆæŠ˜ç·šåœ–
      generateLineChart(cachedData, houseAge);

      // é¡¯ç¤ºçµæœ
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('downloadBtn').classList.remove('hidden');
    }

    function generateBarChart(data, currentAge) {
      const container = document.getElementById('barChart');
      const maxPrice = Math.max(...data.map(d => parseFloat(d.perPing)));
      
      let html = '';
      data.forEach(row => {
        const percentage = (parseFloat(row.perPing) / maxPrice) * 100;
        const ageLabel = row.age === 0 ? 'é å”®å±‹' : `${row.age} å¹´`;
        const highlight = row.isCurrent ? 'style="background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);"' : '';
        
        html += `
          <div class="bar-item">
            <div class="bar-label">${ageLabel}</div>
            <div class="bar-wrapper">
              <div class="bar" style="width: ${percentage}%;" ${highlight}>
                <span class="bar-value">${row.perPing} è¬</span>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function generateLineChart(data, currentAge) {
      const container = document.getElementById('lineChart');
      const containerWidth = container.offsetWidth || 900;
      const width = containerWidth;
      const height = 300;
      const padding = { top: 30, right: 30, bottom: 50, left: 60 };
      
      const maxPrice = Math.max(...data.map(d => parseFloat(d.perPing)));
      const minPrice = Math.min(...data.map(d => parseFloat(d.perPing)));
      const priceRange = maxPrice - minPrice;
      
      // è¨ˆç®—ç¹ªåœ–å€åŸŸçš„å¯¬åº¦å’Œé«˜åº¦
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;
      
      // è¨ˆç®—åº§æ¨™
      const points = data.map((d, i) => {
        const x = padding.left + (i / (data.length - 1)) * chartWidth;
        const y = padding.top + (1 - (parseFloat(d.perPing) - minPrice) / priceRange) * chartHeight;
        return { x, y, ...d };
      });
      
      // ç”Ÿæˆè·¯å¾‘
      const pathData = points.map((p, i) => 
        `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
      ).join(' ');
      
      // ç”Ÿæˆå¡«å……å€åŸŸ
      const areaData = `M ${points[0].x} ${padding.top + chartHeight} L ${pathData.substring(2)} L ${points[points.length - 1].x} ${padding.top + chartHeight} Z`;
      
      let svg = `
        <svg viewBox="0 0 ${width} ${height}" width="100%" height="${height}" preserveAspectRatio="xMidYMid meet" style="overflow: visible;">
          <!-- èƒŒæ™¯ -->
          <rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}" fill="#fafafa" />
          
          <!-- ç¶²æ ¼ç·š -->
          ${points.map(p => `
            <line x1="${p.x}" y1="${padding.top + chartHeight}" x2="${p.x}" y2="${padding.top}" 
                  stroke="#ddd" stroke-width="1" stroke-dasharray="3,3"/>
          `).join('')}
          
          <!-- å¡«å……å€åŸŸ -->
          <path d="${areaData}" fill="rgba(102, 126, 234, 0.1)" />
          
          <!-- æŠ˜ç·š -->
          <path d="${pathData}" stroke="#667eea" stroke-width="3" fill="none" />
          
          <!-- æ•¸æ“šé» -->
          ${points.map(p => `
            <circle cx="${p.x}" cy="${p.y}" r="${p.isCurrent ? '8' : '5'}" 
                    fill="${p.isCurrent ? '#f5576c' : '#667eea'}" 
                    stroke="white" stroke-width="2">
              <title>${p.age === 0 ? 'é å”®å±‹' : p.age + 'å¹´'}: ${p.perPing} è¬/åª</title>
            </circle>
          `).join('')}
          
          <!-- åæ¨™è»¸ -->
          <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${padding.top + chartHeight}" stroke="#333" stroke-width="2"/>
          <line x1="${padding.left}" y1="${padding.top + chartHeight}" x2="${padding.left + chartWidth}" y2="${padding.top + chartHeight}" stroke="#333" stroke-width="2"/>
          
          <!-- Xè»¸æ¨™ç±¤ -->
          ${points.map(p => `
            <text x="${p.x}" y="${padding.top + chartHeight + 25}" 
                  text-anchor="middle" font-size="12" fill="#666" font-weight="500">
              ${p.age === 0 ? 'æ–°' : p.age}
            </text>
          `).join('')}
          
          <!-- Yè»¸æ¨™ç±¤ -->
          <text x="${padding.left - 10}" y="${padding.top + 5}" text-anchor="end" font-size="12" fill="#666">${maxPrice.toFixed(0)}</text>
          <text x="${padding.left - 10}" y="${padding.top + chartHeight}" text-anchor="end" font-size="12" fill="#666">${minPrice.toFixed(0)}</text>
          <text x="${padding.left - 10}" y="${padding.top + chartHeight / 2}" text-anchor="end" font-size="12" fill="#666">${((maxPrice + minPrice) / 2).toFixed(0)}</text>
          
          <!-- è»¸æ¨™é¡Œ -->
          <text x="${padding.left + chartWidth / 2}" y="${height - 10}" text-anchor="middle" font-size="13" fill="#333" font-weight="600">å±‹é½¡ï¼ˆå¹´ï¼‰</text>
          <text x="15" y="${padding.top + chartHeight / 2}" text-anchor="middle" font-size="13" fill="#333" font-weight="600" transform="rotate(-90 15 ${padding.top + chartHeight / 2})">å–®åªåƒ¹æ ¼ï¼ˆè¬ï¼‰</text>
        </svg>
      `;
      
      container.innerHTML = svg;
    }

    function downloadCSV() {
      if (cachedData.length === 0) {
        alert('è«‹å…ˆè¨ˆç®—çµæœ');
        return;
      }

      const totalPrice = parseFloat(document.getElementById('totalPrice').value);
      const totalPings = parseFloat(document.getElementById('totalPings').value);
      const houseAge = parseInt(document.getElementById('houseAge').value);

      let csvContent = '\uFEFF'; // UTF-8 BOM
      csvContent += 'æˆ¿åƒ¹æŠ˜ç®—è¨ˆç®—çµæœ\n';
      csvContent += `æˆ¿å±‹ç¸½åƒ¹,${totalPrice} è¬å…ƒ\n`;
      csvContent += `åªæ•¸,${totalPings} åª\n`;
      csvContent += `ç›®å‰å±‹é½¡,${houseAge} å¹´\n\n`;
      csvContent += 'å±‹é½¡,æŠ˜èˆŠç‡,æŠ˜ç®—å–®åªåƒ¹æ ¼ï¼ˆè¬ï¼‰,æŠ˜ç®—ç¸½åƒ¹ï¼ˆè¬ï¼‰\n';
      
      cachedData.forEach(row => {
        const ageLabel = row.age === 0 ? 'é å”®å±‹' : `${row.age}å¹´`;
        csvContent += `${ageLabel},${(row.factor * 100).toFixed(1)}%,${row.perPing},${row.total}\n`;
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.setAttribute('href', URL.createObjectURL(blob));
      link.setAttribute('download', 'æˆ¿åƒ¹æŠ˜ç®—çµæœ.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // æŒ‰ Enter éµä¹Ÿå¯ä»¥è¨ˆç®—
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        calculateBackwards();
      }
    });
  </script>
</body>
</html>
