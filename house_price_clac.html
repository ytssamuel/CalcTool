<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>房價折算試算工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <link rel="stylesheet" href="common-styles.css">
  <style>
    /* 頁面特定樣式 */
    .container {
      max-width: 1000px;
    }
    
    .input-row {
      margin-bottom: 1.5em;
    }
    
    .label-hint {
      font-weight: normal;
      color: #666;
      font-size: 0.9em;
      margin-left: 0.5em;
    }
    
    .summary-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2em;
      border-radius: 10px;
      margin: 2em 0;
      text-align: center;
    }
    
    .summary-card h3 {
      margin: 0 0 0.5em 0;
      color: white;
      border: none;
    }
    
    .big-number {
      font-size: 2.5em;
      font-weight: bold;
      margin: 0.5em 0;
    }
    
    .chart-container {
      background: white;
      padding: 2em;
      border-radius: 10px;
      margin: 2em 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .chart-title {
      text-align: center;
      color: #333;
      margin-bottom: 1.5em;
      font-size: 1.3em;
    }
    
    .bar-chart {
      display: flex;
      flex-direction: column;
      gap: 1em;
    }
    
    .bar-item {
      display: flex;
      align-items: center;
      gap: 1em;
    }
    
    .bar-label {
      width: 100px;
      font-weight: bold;
      color: #555;
      font-size: 0.9em;
      text-align: right;
    }
    
    .bar-wrapper {
      flex: 1;
      position: relative;
    }
    
    .bar {
      height: 40px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 1em;
      color: white;
      font-weight: bold;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .bar:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .bar-value {
      font-size: 1em;
    }
    
    .line-chart {
      width: 100%;
      min-height: 300px;
      position: relative;
      margin-top: 1em;
    }
    
    .line-chart svg {
      display: block;
      max-width: 100%;
    }
    
    .hidden {
      display: none;
    }
    
    th, td {
      text-align: center;
    }
    
    .highlight-row {
      background: #e3f2fd !important;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .bar-label {
        width: 80px;
        font-size: 0.8em;
      }
      
      .big-number {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🏘️ 房價折算試算工具</h1>

    <div class="input-group">
      <div class="info-box">
        <p>📌 輸入房屋資訊，自動計算不同屋齡下的折算價格與圖表分析</p>
      </div>

      <div class="input-row">
        <label>
          房屋總價（萬元）:
          <span class="label-hint">例如：2400 萬元</span>
        </label>
        <input type="number" id="totalPrice" placeholder="例如：2400" value="2400">
      </div>

      <div class="input-row">
        <label>
          坪數:
          <span class="label-hint">建物坪數</span>
        </label>
        <input type="number" id="totalPings" placeholder="例如：30" value="30" step="0.1">
      </div>

      <div class="input-row">
        <label>
          屋齡（年）:
          <span class="label-hint">0 = 預售屋，50+ = 老屋</span>
        </label>
        <input type="number" id="houseAge" placeholder="例如：10" value="10" min="0" max="60">
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="calculateBackwards()">開始計算</button>
        <button class="btn-secondary hidden" id="downloadBtn" onclick="downloadCSV()">下載結果（CSV）</button>
      </div>
    </div>

    <div class="hidden" id="result">
      <div class="summary-card">
        <h3>🎯 推算原始單坪價格</h3>
        <div class="big-number" id="originalPrice">-</div>
        <p style="margin: 0; opacity: 0.9;">萬元/坪</p>
      </div>

      <div class="chart-container">
        <h3 class="chart-title">📊 不同屋齡折算單坪價格</h3>
        <div class="bar-chart" id="barChart"></div>
      </div>

      <div class="chart-container">
        <h3 class="chart-title">📈 房價折舊趨勢圖</h3>
        <div class="line-chart" id="lineChart"></div>
      </div>

      <h3 style="color: #333; margin-top: 2em;">📋 詳細折算表</h3>
      <div style="overflow-x: auto;">
        <table id="resultTable">
          <thead>
            <tr>
              <th>屋齡</th>
              <th>折舊率</th>
              <th>折算單坪價格（萬）</th>
              <th>折算總價（萬）</th>
            </tr>
          </thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let cachedData = [];

    // 計算折舊係數：線性遞減，從 100% (預售屋) 到 60% (50年以上老屋)
    function getDepreciationFactor(age) {
      if (age <= 0) return 1.0; // 預售屋 100%
      if (age >= 50) return 0.6; // 50年以上 60%
      // 線性遞減：每年遞減 0.8%
      return 1.0 - (age * 0.008);
    }

    function calculateBackwards() {
      const totalPrice = parseFloat(document.getElementById('totalPrice').value);
      const totalPings = parseFloat(document.getElementById('totalPings').value);
      const houseAge = parseInt(document.getElementById('houseAge').value);

      if (isNaN(totalPrice) || isNaN(totalPings) || isNaN(houseAge) || totalPings === 0) {
        alert('請輸入有效的數值！');
        return;
      }

      const currentPerPing = totalPrice / totalPings;
      const currentFactor = getDepreciationFactor(houseAge);
      const originalPerPing = currentPerPing / currentFactor;

      // 顯示原始單坪價格
      document.getElementById('originalPrice').textContent = originalPerPing.toFixed(2);

      // 生成不同屋齡的數據
      cachedData = [];
      const ages = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50];
      
      for (const age of ages) {
        const factor = getDepreciationFactor(age);
        const adjustedPerPing = originalPerPing * factor;
        const adjustedTotalPrice = adjustedPerPing * totalPings;
        const isCurrentAge = age === houseAge;
        
        cachedData.push({
          age: age,
          factor: factor,
          perPing: adjustedPerPing.toFixed(2),
          total: adjustedTotalPrice.toFixed(2),
          isCurrent: isCurrentAge
        });
      }

      // 生成表格
      let tableRows = '';
      cachedData.forEach(row => {
        const rowClass = row.isCurrent ? 'class="highlight-row"' : '';
        const ageLabel = row.age === 0 ? '預售屋' : `${row.age} 年`;
        tableRows += `
          <tr ${rowClass}>
            <td>${ageLabel}</td>
            <td>${(row.factor * 100).toFixed(1)}%</td>
            <td>${row.perPing}</td>
            <td>${row.total}</td>
          </tr>
        `;
      });
      document.getElementById('resultBody').innerHTML = tableRows;

      // 生成長條圖
      generateBarChart(cachedData, houseAge);

      // 生成折線圖
      generateLineChart(cachedData, houseAge);

      // 顯示結果
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('downloadBtn').classList.remove('hidden');
    }

    function generateBarChart(data, currentAge) {
      const container = document.getElementById('barChart');
      const maxPrice = Math.max(...data.map(d => parseFloat(d.perPing)));
      
      let html = '';
      data.forEach(row => {
        const percentage = (parseFloat(row.perPing) / maxPrice) * 100;
        const ageLabel = row.age === 0 ? '預售屋' : `${row.age} 年`;
        const highlight = row.isCurrent ? 'style="background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);"' : '';
        
        html += `
          <div class="bar-item">
            <div class="bar-label">${ageLabel}</div>
            <div class="bar-wrapper">
              <div class="bar" style="width: ${percentage}%;" ${highlight}>
                <span class="bar-value">${row.perPing} 萬</span>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function generateLineChart(data, currentAge) {
      const container = document.getElementById('lineChart');
      const containerWidth = container.offsetWidth || 900;
      const width = containerWidth;
      const height = 300;
      const padding = { top: 30, right: 30, bottom: 50, left: 60 };
      
      const maxPrice = Math.max(...data.map(d => parseFloat(d.perPing)));
      const minPrice = Math.min(...data.map(d => parseFloat(d.perPing)));
      const priceRange = maxPrice - minPrice;
      
      // 計算繪圖區域的寬度和高度
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;
      
      // 計算座標
      const points = data.map((d, i) => {
        const x = padding.left + (i / (data.length - 1)) * chartWidth;
        const y = padding.top + (1 - (parseFloat(d.perPing) - minPrice) / priceRange) * chartHeight;
        return { x, y, ...d };
      });
      
      // 生成路徑
      const pathData = points.map((p, i) => 
        `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
      ).join(' ');
      
      // 生成填充區域
      const areaData = `M ${points[0].x} ${padding.top + chartHeight} L ${pathData.substring(2)} L ${points[points.length - 1].x} ${padding.top + chartHeight} Z`;
      
      let svg = `
        <svg viewBox="0 0 ${width} ${height}" width="100%" height="${height}" preserveAspectRatio="xMidYMid meet" style="overflow: visible;">
          <!-- 背景 -->
          <rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}" fill="#fafafa" />
          
          <!-- 網格線 -->
          ${points.map(p => `
            <line x1="${p.x}" y1="${padding.top + chartHeight}" x2="${p.x}" y2="${padding.top}" 
                  stroke="#ddd" stroke-width="1" stroke-dasharray="3,3"/>
          `).join('')}
          
          <!-- 填充區域 -->
          <path d="${areaData}" fill="rgba(102, 126, 234, 0.1)" />
          
          <!-- 折線 -->
          <path d="${pathData}" stroke="#667eea" stroke-width="3" fill="none" />
          
          <!-- 數據點 -->
          ${points.map(p => `
            <circle cx="${p.x}" cy="${p.y}" r="${p.isCurrent ? '8' : '5'}" 
                    fill="${p.isCurrent ? '#f5576c' : '#667eea'}" 
                    stroke="white" stroke-width="2">
              <title>${p.age === 0 ? '預售屋' : p.age + '年'}: ${p.perPing} 萬/坪</title>
            </circle>
          `).join('')}
          
          <!-- 坐標軸 -->
          <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${padding.top + chartHeight}" stroke="#333" stroke-width="2"/>
          <line x1="${padding.left}" y1="${padding.top + chartHeight}" x2="${padding.left + chartWidth}" y2="${padding.top + chartHeight}" stroke="#333" stroke-width="2"/>
          
          <!-- X軸標籤 -->
          ${points.map(p => `
            <text x="${p.x}" y="${padding.top + chartHeight + 25}" 
                  text-anchor="middle" font-size="12" fill="#666" font-weight="500">
              ${p.age === 0 ? '新' : p.age}
            </text>
          `).join('')}
          
          <!-- Y軸標籤 -->
          <text x="${padding.left - 10}" y="${padding.top + 5}" text-anchor="end" font-size="12" fill="#666">${maxPrice.toFixed(0)}</text>
          <text x="${padding.left - 10}" y="${padding.top + chartHeight}" text-anchor="end" font-size="12" fill="#666">${minPrice.toFixed(0)}</text>
          <text x="${padding.left - 10}" y="${padding.top + chartHeight / 2}" text-anchor="end" font-size="12" fill="#666">${((maxPrice + minPrice) / 2).toFixed(0)}</text>
          
          <!-- 軸標題 -->
          <text x="${padding.left + chartWidth / 2}" y="${height - 10}" text-anchor="middle" font-size="13" fill="#333" font-weight="600">屋齡（年）</text>
          <text x="15" y="${padding.top + chartHeight / 2}" text-anchor="middle" font-size="13" fill="#333" font-weight="600" transform="rotate(-90 15 ${padding.top + chartHeight / 2})">單坪價格（萬）</text>
        </svg>
      `;
      
      container.innerHTML = svg;
    }

    function downloadCSV() {
      if (cachedData.length === 0) {
        alert('請先計算結果');
        return;
      }

      const totalPrice = parseFloat(document.getElementById('totalPrice').value);
      const totalPings = parseFloat(document.getElementById('totalPings').value);
      const houseAge = parseInt(document.getElementById('houseAge').value);

      let csvContent = '\uFEFF'; // UTF-8 BOM
      csvContent += '房價折算計算結果\n';
      csvContent += `房屋總價,${totalPrice} 萬元\n`;
      csvContent += `坪數,${totalPings} 坪\n`;
      csvContent += `目前屋齡,${houseAge} 年\n\n`;
      csvContent += '屋齡,折舊率,折算單坪價格（萬）,折算總價（萬）\n';
      
      cachedData.forEach(row => {
        const ageLabel = row.age === 0 ? '預售屋' : `${row.age}年`;
        csvContent += `${ageLabel},${(row.factor * 100).toFixed(1)}%,${row.perPing},${row.total}\n`;
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.setAttribute('href', URL.createObjectURL(blob));
      link.setAttribute('download', '房價折算結果.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // 按 Enter 鍵也可以計算
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        calculateBackwards();
      }
    });
  </script>
</body>
</html>
