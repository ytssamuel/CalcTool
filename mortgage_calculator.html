<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æˆ¿è²¸è©¦ç®—å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <link rel="stylesheet" href="common-styles.css">
  <style>
    /* é é¢ç‰¹å®šæ¨£å¼ */
    body {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .container {
      max-width: 1200px;
      background: white;
    }
    
    h1 {
      color: #333;
      text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
    }
    
    .input-row {
      margin-bottom: 1.5em;
    }
    
    .label-hint {
      font-weight: normal;
      color: #666;
      font-size: 0.9em;
      margin-left: 0.5em;
    }
    
    .input-group-inline {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1em;
    }
    
    .rate-type-selector {
      display: flex;
      gap: 1em;
      margin-bottom: 1em;
    }
    
    .rate-type-btn {
      flex: 1;
      padding: 0.8em;
      border: 2px solid #ddd;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1em;
    }
    
    .rate-type-btn:hover {
      border-color: #f093fb;
    }
    
    .rate-type-btn.active {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-color: #f093fb;
    }
    
    .rate-section {
      background: #f8f9fa;
      padding: 1.5em;
      border-radius: 8px;
      margin-bottom: 1em;
    }
    
    .rate-period {
      background: white;
      padding: 1em;
      border-radius: 6px;
      margin-bottom: 1em;
      border: 1px solid #ddd;
    }
    
    .rate-period-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8em;
      padding-bottom: 0.5em;
      border-bottom: 2px solid #f093fb;
    }
    
    .rate-period-title {
      font-weight: bold;
      color: #f5576c;
    }
    
    .summary-overview {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2em;
      border-radius: 10px;
      margin-bottom: 2em;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .summary-overview h2 {
      margin-top: 0;
      color: white;
      border: none;
      text-align: center;
      margin-bottom: 1.5em;
    }
    
    .big-number {
      font-size: 2.5em;
      font-weight: bold;
      text-align: center;
      margin: 0.5em 0;
      color: white;
    }
    
    .summary-subtitle {
      font-size: 1.1em;
      text-align: center;
      margin-bottom: 1.5em;
      color: white;
      opacity: 0.95;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1em;
    }
    
    .stat-box {
      background: rgba(255,255,255,0.2);
      padding: 1em;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
      margin-bottom: 0.5em;
    }
    
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
    }
    
    .payment-method-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1em;
      margin-bottom: 1.5em;
    }
    
    .payment-method-btn {
      padding: 1em;
      border: 2px solid #ddd;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    
    .payment-method-btn:hover {
      border-color: #f093fb;
    }
    
    .payment-method-btn.active {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-color: #f093fb;
    }
    
    .payment-method-title {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 0.3em;
    }
    
    .payment-method-desc {
      font-size: 0.9em;
      opacity: 0.8;
    }
    
    .hidden {
      display: none;
    }
    
    .table-container {
      max-height: 500px;
      overflow-y: auto;
    }
    
    th, td {
      text-align: center;
    }
    
    @media (max-width: 768px) {
      .input-group-inline,
      .payment-method-selector {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .big-number {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ  æˆ¿è²¸è©¦ç®—å·¥å…·</h1>

    <div class="input-group">
      <div class="info-box">
        <p>ğŸ“Œ æ­¤å·¥å…·å¯å¹«æ‚¨è©¦ç®—æˆ¿å±‹è²¸æ¬¾ï¼Œæ”¯æ´å–®ä¸€åˆ©ç‡æˆ–åˆ†æ®µåˆ©ç‡ï¼Œä»¥åŠä¸åŒçš„é‚„æ¬¾æ–¹å¼</p>
      </div>

      <div class="input-group-inline">
        <div class="input-row">
          <label>
            æˆ¿å±‹ç¸½åƒ¹ï¼ˆå…ƒï¼‰:
            <span class="label-hint">æˆ¿å±‹åƒ¹æ ¼</span>
          </label>
          <input type="number" id="housePrice" placeholder="ä¾‹å¦‚ï¼š10000000" value="10000000">
        </div>
        
        <div class="input-row">
          <label>
            è²¸æ¬¾æˆæ•¸ï¼ˆ%ï¼‰:
            <span class="label-hint">é€šå¸¸ç‚º 70-80%</span>
          </label>
          <input type="number" id="loanRatio" placeholder="ä¾‹å¦‚ï¼š80" value="80" min="1" max="100">
        </div>
      </div>

      <div class="input-row">
        <label>è²¸æ¬¾æœŸæ•¸:</label>
        <div class="input-group-inline">
          <div>
            <input type="number" id="loanYears" placeholder="å¹´æ•¸" value="20" min="1">
            <span class="label-hint">å¹´</span>
          </div>
          <div>
            <input type="number" id="loanMonths" placeholder="æœˆæ•¸" value="0" min="0" max="11">
            <span class="label-hint">æœˆï¼ˆ0-11ï¼‰</span>
          </div>
        </div>
      </div>

      <h3 style="margin-top: 2em;">ğŸ“Š åˆ©ç‡è¨­å®š</h3>
      <div class="rate-type-selector">
        <button class="rate-type-btn active" onclick="setRateType('single')">å–®ä¸€åˆ©ç‡</button>
        <button class="rate-type-btn" onclick="setRateType('staged')">åˆ†æ®µåˆ©ç‡</button>
      </div>

      <div id="singleRateSection" class="rate-section">
        <div class="input-row">
          <label>
            å¹´åˆ©ç‡ï¼ˆ%ï¼‰:
            <span class="label-hint">ä¾‹å¦‚ï¼š1.5</span>
          </label>
          <input type="number" id="singleRate" placeholder="ä¾‹å¦‚ï¼š1.5" value="1.5" step="0.01">
        </div>
      </div>

      <div id="stagedRateSection" class="rate-section hidden">
        <div id="ratePeriods">
          <div class="rate-period">
            <div class="rate-period-header">
              <span class="rate-period-title">ç¬¬ 1 æ®µ</span>
              <button class="btn-danger btn-sm" onclick="removeRatePeriod(this)" style="display: none;">åˆªé™¤</button>
            </div>
            <div class="input-group-inline">
              <div class="input-row">
                <label>æœŸæ•¸ï¼ˆæœˆï¼‰:</label>
                <input type="number" class="period-months" placeholder="ä¾‹å¦‚ï¼š24" value="24" min="1">
              </div>
              <div class="input-row">
                <label>å¹´åˆ©ç‡ï¼ˆ%ï¼‰:</label>
                <input type="number" class="period-rate" placeholder="ä¾‹å¦‚ï¼š1.5" value="1.5" step="0.01">
              </div>
            </div>
          </div>
        </div>
        <button class="btn-add" onclick="addRatePeriod()">â• æ–°å¢åˆ©ç‡æ®µ</button>
      </div>

      <h3 style="margin-top: 2em;">ğŸ’³ é‚„æ¬¾æ–¹å¼</h3>
      <div class="payment-method-selector">
        <div class="payment-method-btn active" onclick="setPaymentMethod('amortization')">
          <div class="payment-method-title">æœ¬æ¯å¹³å‡æ”¤é‚„</div>
          <div class="payment-method-desc">æ¯æœˆé‚„æ¬¾é‡‘é¡å›ºå®š</div>
        </div>
        <div class="payment-method-btn" onclick="setPaymentMethod('principal')">
          <div class="payment-method-title">æœ¬é‡‘å¹³å‡æ”¤é‚„</div>
          <div class="payment-method-desc">æœ¬é‡‘å›ºå®šï¼Œåˆ©æ¯éæ¸›</div>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="calculate()">é–‹å§‹è©¦ç®—</button>
        <button class="btn-secondary hidden" id="downloadBtn" onclick="downloadCSV()">ä¸‹è¼‰çµæœï¼ˆCSVï¼‰</button>
      </div>
    </div>

    <div class="hidden" id="result">
      <div class="summary-overview">
        <h2>ğŸ¯ è²¸æ¬¾è©¦ç®—çµæœ</h2>
        <div class="big-number" id="loanAmount">-</div>
        <div class="summary-subtitle">è²¸æ¬¾ç¸½é¡</div>
        
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">é¦–æœˆé‚„æ¬¾é‡‘é¡</div>
            <div class="stat-value" id="firstPayment">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">ç¸½åˆ©æ¯</div>
            <div class="stat-value" id="totalInterest">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">ç¸½é‚„æ¬¾é‡‘é¡</div>
            <div class="stat-value" id="totalPayment">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">è²¸æ¬¾æœŸæ•¸</div>
            <div class="stat-value" id="loanPeriod">-</div>
          </div>
        </div>
      </div>

      <h3 style="color: #333;">ğŸ“ˆ é‚„æ¬¾æ˜ç´°è¡¨</h3>
      <div class="table-container">
        <table id="resultTable">
          <thead>
            <tr>
              <th>æœŸæ•¸</th>
              <th>æœ¬é‡‘ï¼ˆå…ƒï¼‰</th>
              <th>åˆ©æ¯ï¼ˆå…ƒï¼‰</th>
              <th>æœˆä»˜é‡‘ï¼ˆå…ƒï¼‰</th>
              <th>å‰©é¤˜æœ¬é‡‘ï¼ˆå…ƒï¼‰</th>
            </tr>
          </thead>
          <tbody id="resultBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let rateType = 'single'; // 'single' or 'staged'
    let paymentMethod = 'amortization'; // 'amortization' or 'principal'
    let cachedData = [];
    let ratePeriodCount = 1;

    function setRateType(type) {
      rateType = type;
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.rate-type-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // é¡¯ç¤º/éš±è—å°æ‡‰å€å¡Š
      if (type === 'single') {
        document.getElementById('singleRateSection').classList.remove('hidden');
        document.getElementById('stagedRateSection').classList.add('hidden');
      } else {
        document.getElementById('singleRateSection').classList.add('hidden');
        document.getElementById('stagedRateSection').classList.remove('hidden');
      }
    }

    function setPaymentMethod(method) {
      paymentMethod = method;
      
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.closest('.payment-method-btn').classList.add('active');
    }

    function addRatePeriod() {
      ratePeriodCount++;
      const container = document.getElementById('ratePeriods');
      
      const periodDiv = document.createElement('div');
      periodDiv.className = 'rate-period';
      periodDiv.innerHTML = `
        <div class="rate-period-header">
          <span class="rate-period-title">ç¬¬ ${ratePeriodCount} æ®µ</span>
          <button class="btn-danger btn-sm" onclick="removeRatePeriod(this)">åˆªé™¤</button>
        </div>
        <div class="input-group-inline">
          <div class="input-row">
            <label>æœŸæ•¸ï¼ˆæœˆï¼‰:</label>
            <input type="number" class="period-months" placeholder="ä¾‹å¦‚ï¼š24" value="24" min="1">
          </div>
          <div class="input-row">
            <label>å¹´åˆ©ç‡ï¼ˆ%ï¼‰:</label>
            <input type="number" class="period-rate" placeholder="ä¾‹å¦‚ï¼š1.5" value="1.5" step="0.01">
          </div>
        </div>
      `;
      
      container.appendChild(periodDiv);
      updateRatePeriodNumbers();
    }

    function removeRatePeriod(btn) {
      btn.closest('.rate-period').remove();
      ratePeriodCount--;
      updateRatePeriodNumbers();
    }

    function updateRatePeriodNumbers() {
      const periods = document.querySelectorAll('.rate-period');
      periods.forEach((period, index) => {
        const title = period.querySelector('.rate-period-title');
        title.textContent = `ç¬¬ ${index + 1} æ®µ`;
        
        // ç¬¬ä¸€æ®µä¸é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
        const deleteBtn = period.querySelector('.btn-danger');
        if (index === 0) {
          deleteBtn.style.display = 'none';
        } else {
          deleteBtn.style.display = 'inline-block';
        }
      });
    }

    function calculate() {
      const housePrice = parseFloat(document.getElementById('housePrice').value);
      const loanRatio = parseFloat(document.getElementById('loanRatio').value);
      const loanYears = parseInt(document.getElementById('loanYears').value) || 0;
      const loanMonths = parseInt(document.getElementById('loanMonths').value) || 0;

      if (isNaN(housePrice) || isNaN(loanRatio) || housePrice <= 0 || loanRatio <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆ¿å±‹ç¸½åƒ¹å’Œè²¸æ¬¾æˆæ•¸ï¼');
        return;
      }

      const totalMonths = loanYears * 12 + loanMonths;
      if (totalMonths <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è²¸æ¬¾æœŸæ•¸ï¼');
        return;
      }

      const loanAmount = housePrice * (loanRatio / 100);

      // ç²å–åˆ©ç‡è¨­å®š
      let rateSchedule = [];
      if (rateType === 'single') {
        const rate = parseFloat(document.getElementById('singleRate').value);
        if (isNaN(rate) || rate <= 0) {
          alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åˆ©ç‡ï¼');
          return;
        }
        rateSchedule.push({ months: totalMonths, rate: rate });
      } else {
        const periods = document.querySelectorAll('.rate-period');
        let totalPeriodMonths = 0;
        
        periods.forEach(period => {
          const months = parseInt(period.querySelector('.period-months').value);
          const rate = parseFloat(period.querySelector('.period-rate').value);
          
          if (isNaN(months) || isNaN(rate) || months <= 0 || rate <= 0) {
            alert('è«‹ç¢ºèªæ‰€æœ‰åˆ©ç‡æ®µçš„æœŸæ•¸å’Œåˆ©ç‡éƒ½å·²æ­£ç¢ºå¡«å¯«ï¼');
            return;
          }
          
          rateSchedule.push({ months: months, rate: rate });
          totalPeriodMonths += months;
        });

        if (totalPeriodMonths !== totalMonths) {
          alert(`åˆ†æ®µåˆ©ç‡çš„ç¸½æœŸæ•¸ï¼ˆ${totalPeriodMonths}æœˆï¼‰å¿…é ˆç­‰æ–¼è²¸æ¬¾æœŸæ•¸ï¼ˆ${totalMonths}æœˆï¼‰ï¼`);
          return;
        }
      }

      // è¨ˆç®—é‚„æ¬¾æ˜ç´°
      cachedData = [];
      let remainingPrincipal = loanAmount;
      let totalInterestPaid = 0;
      let currentPeriodIndex = 0;
      let monthsInCurrentPeriod = 0;

      for (let month = 1; month <= totalMonths; month++) {
        // åˆ¤æ–·ç•¶å‰æœˆä»½çš„åˆ©ç‡
        if (rateType === 'staged') {
          while (monthsInCurrentPeriod >= rateSchedule[currentPeriodIndex].months && currentPeriodIndex < rateSchedule.length - 1) {
            monthsInCurrentPeriod = 0;
            currentPeriodIndex++;
          }
          monthsInCurrentPeriod++;
        }

        const currentRate = rateSchedule[currentPeriodIndex].rate;
        const monthlyRate = currentRate / 100 / 12;

        let principal, interest, monthlyPayment;

        if (paymentMethod === 'amortization') {
          // æœ¬æ¯å¹³å‡æ”¤é‚„
          const remainingMonths = totalMonths - month + 1;
          monthlyPayment = remainingPrincipal * monthlyRate * Math.pow(1 + monthlyRate, remainingMonths) / 
                          (Math.pow(1 + monthlyRate, remainingMonths) - 1);
          interest = remainingPrincipal * monthlyRate;
          principal = monthlyPayment - interest;
        } else {
          // æœ¬é‡‘å¹³å‡æ”¤é‚„
          principal = loanAmount / totalMonths;
          interest = remainingPrincipal * monthlyRate;
          monthlyPayment = principal + interest;
        }

        remainingPrincipal -= principal;
        totalInterestPaid += interest;

        cachedData.push({
          month: month,
          principal: Math.round(principal),
          interest: Math.round(interest),
          payment: Math.round(monthlyPayment),
          remaining: Math.round(remainingPrincipal)
        });
      }

      const totalPayment = loanAmount + totalInterestPaid;
      const firstPayment = cachedData[0].payment;

      // æ›´æ–°ç¸½è¦½
      document.getElementById('loanAmount').textContent = '$ ' + Math.round(loanAmount).toLocaleString('zh-TW');
      document.getElementById('firstPayment').textContent = firstPayment.toLocaleString('zh-TW') + ' å…ƒ';
      document.getElementById('totalInterest').textContent = Math.round(totalInterestPaid).toLocaleString('zh-TW') + ' å…ƒ';
      document.getElementById('totalPayment').textContent = Math.round(totalPayment).toLocaleString('zh-TW') + ' å…ƒ';
      document.getElementById('loanPeriod').textContent = `${loanYears}å¹´${loanMonths}æœˆ`;

      // ç”Ÿæˆè¡¨æ ¼ï¼ˆé¡¯ç¤ºæ‰€æœ‰æœŸæ•¸ï¼‰
      let tableRows = '';
      
      cachedData.forEach((data) => {
        tableRows += `
          <tr>
            <td><strong>${data.month}</strong></td>
            <td>${data.principal.toLocaleString('zh-TW')}</td>
            <td>${data.interest.toLocaleString('zh-TW')}</td>
            <td><strong>${data.payment.toLocaleString('zh-TW')}</strong></td>
            <td>${data.remaining.toLocaleString('zh-TW')}</td>
          </tr>
        `;
      });

      document.getElementById('resultBody').innerHTML = tableRows;

      // é¡¯ç¤ºçµæœ
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('downloadBtn').classList.remove('hidden');
    }

    function downloadCSV() {
      if (cachedData.length === 0) {
        alert('è«‹å…ˆè¨ˆç®—çµæœ');
        return;
      }

      const housePrice = parseFloat(document.getElementById('housePrice').value);
      const loanRatio = parseFloat(document.getElementById('loanRatio').value);
      const loanAmount = housePrice * (loanRatio / 100);
      const totalInterest = cachedData.reduce((sum, data) => sum + data.interest, 0);
      const totalPayment = loanAmount + totalInterest;

      let csvContent = '\uFEFF'; // UTF-8 BOM
      csvContent += 'æˆ¿è²¸è©¦ç®—çµæœ\n';
      csvContent += `æˆ¿å±‹ç¸½åƒ¹,${housePrice}\n`;
      csvContent += `è²¸æ¬¾æˆæ•¸,${loanRatio}%\n`;
      csvContent += `è²¸æ¬¾é‡‘é¡,${Math.round(loanAmount)}\n`;
      csvContent += `é‚„æ¬¾æ–¹å¼,${paymentMethod === 'amortization' ? 'æœ¬æ¯å¹³å‡æ”¤é‚„' : 'æœ¬é‡‘å¹³å‡æ”¤é‚„'}\n`;
      csvContent += `ç¸½åˆ©æ¯,${Math.round(totalInterest)}\n`;
      csvContent += `ç¸½é‚„æ¬¾é‡‘é¡,${Math.round(totalPayment)}\n\n`;
      csvContent += 'æœŸæ•¸,æœ¬é‡‘ï¼ˆå…ƒï¼‰,åˆ©æ¯ï¼ˆå…ƒï¼‰,æœˆä»˜é‡‘ï¼ˆå…ƒï¼‰,å‰©é¤˜æœ¬é‡‘ï¼ˆå…ƒï¼‰\n';
      
      cachedData.forEach(data => {
        csvContent += `${data.month},${data.principal},${data.interest},${data.payment},${data.remaining}\n`;
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.setAttribute('href', URL.createObjectURL(blob));
      link.setAttribute('download', 'æˆ¿è²¸è©¦ç®—çµæœ.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // æŒ‰ Enter éµä¹Ÿå¯ä»¥è¨ˆç®—
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        calculate();
      }
    });
  </script>
</body>
</html>
